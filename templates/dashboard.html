{% extends "base.html" %}

{% block title %}儀表板 - 員工管理系統{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">儀表板</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <span class="text-muted" id="currentDate">今日：</span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>打卡功能
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-6">
                        <button onclick="clockIn()" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="fas fa-sign-in-alt me-2"></i>上班打卡
                        </button>
                    </div>
                    <div class="col-6">
                        <button onclick="clockOut()" class="btn btn-warning btn-lg w-100 mb-2">
                            <i class="fas fa-sign-out-alt me-2"></i>下班打卡
                        </button>
                    </div>
                </div>
                <small class="text-muted">請在上班和下班時進行打卡</small>
                <div id="locationStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>個人資訊
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <p><strong>員工編號：</strong>{{ current_user.employee_id }}</p>
                        <p><strong>姓名：</strong>{{ current_user.name }}</p>
                        <p><strong>帳號：</strong>{{ current_user.username }}</p>
                    </div>
                    <div class="col-6">
                        <p><strong>職位：</strong>{% if current_user.is_admin %}管理員{% else %}員工{% endif %}</p>
                        <p><strong>狀態：</strong>
                            {% if current_user.is_active %}
                                <span class="badge bg-success">啟用</span>
                            {% else %}
                                <span class="badge bg-danger">停用</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_admin %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>管理員功能
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <a href="{{ url_for('employee_management') }}" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-users me-2"></i>員工管理
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('attendance_records') }}" class="btn btn-info w-100 mb-2">
                            <i class="fas fa-clock me-2"></i>出勤記錄
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('export_attendance_excel') }}" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-file-excel me-2"></i>匯出Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// 顯示當前時間
function updateTime() {
    const now = new Date();
    const timeString = now.getFullYear() + '年' + 
                      String(now.getMonth() + 1).padStart(2, '0') + '月' + 
                      String(now.getDate()).padStart(2, '0') + '日';
    document.getElementById('currentDate').textContent = '今日：' + timeString;
}

updateTime();
setInterval(updateTime, 1000);

// GPS定位功能
let currentLocation = null;

// 獲取GPS位置
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('瀏覽器不支援GPS定位'));
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                resolve(currentLocation);
            },
            (error) => {
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    });
}

// 將GPS座標轉換為中文地址
async function getAddressFromCoordinates(lat, lng) {
    try {
        // 使用Google Geocoding API (免費版本)
        const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=YOUR_GOOGLE_API_KEY&language=zh-TW`);
        const data = await response.json();
        
        if (data.status === 'OK' && data.results.length > 0) {
            return data.results[0].formatted_address;
        } else {
            // 如果沒有Google API key，使用備用方案
            return `緯度: ${lat.toFixed(6)}, 經度: ${lng.toFixed(6)}`;
        }
    } catch (error) {
        // 備用方案：直接顯示座標
        return `緯度: ${lat.toFixed(6)}, 經度: ${lng.toFixed(6)}`;
    }
}

// 上班打卡
async function clockIn() {
    try {
        showLocationStatus('正在獲取GPS位置...', 'info');
        
        const location = await getCurrentLocation();
        const address = await getAddressFromCoordinates(location.latitude, location.longitude);
        
        showLocationStatus(`位置: ${address}`, 'success');
        
        // 發送打卡請求
        const response = await fetch('/clock_in', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                latitude: location.latitude,
                longitude: location.longitude,
                address: address
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showLocationStatus('上班打卡成功！', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showLocationStatus(result.message || '打卡失敗', 'danger');
            }
        } else {
            showLocationStatus('打卡失敗，請重試', 'danger');
        }
        
    } catch (error) {
        console.error('打卡錯誤:', error);
        showLocationStatus('GPS定位失敗，請檢查權限', 'warning');
        
        // 即使GPS失敗，也嘗試打卡
        try {
            const response = await fetch('/clock_in', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: null,
                    longitude: null,
                    address: 'GPS定位失敗'
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    showLocationStatus('上班打卡成功！(無GPS)', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            }
        } catch (clockError) {
            showLocationStatus('打卡失敗，請重試', 'danger');
        }
    }
}

// 下班打卡
async function clockOut() {
    try {
        showLocationStatus('正在獲取GPS位置...', 'info');
        
        const location = await getCurrentLocation();
        const address = await getAddressFromCoordinates(location.latitude, location.longitude);
        
        showLocationStatus(`位置: ${address}`, 'success');
        
        // 發送打卡請求
        const response = await fetch('/clock_out', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                latitude: location.latitude,
                longitude: location.longitude,
                address: address
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showLocationStatus('下班打卡成功！', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showLocationStatus(result.message || '打卡失敗', 'danger');
            }
        } else {
            showLocationStatus('打卡失敗，請重試', 'danger');
        }
        
    } catch (error) {
        console.error('打卡錯誤:', error);
        showLocationStatus('GPS定位失敗，請檢查權限', 'warning');
        
        // 即使GPS失敗，也嘗試打卡
        try {
            const response = await fetch('/clock_out', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: null,
                    longitude: null,
                    address: 'GPS定位失敗'
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    showLocationStatus('下班打卡成功！(無GPS)', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            }
        } catch (clockError) {
            showLocationStatus('打卡失敗，請重試', 'danger');
        }
    }
}

// 顯示位置狀態
function showLocationStatus(message, type) {
    const statusDiv = document.getElementById('locationStatus');
    statusDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <i class="fas fa-map-marker-alt me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}

// 檢查GPS權限
function checkGPSPermission() {
    if (navigator.permissions) {
        navigator.permissions.query({ name: 'geolocation' }).then((result) => {
            if (result.state === 'denied') {
                showLocationStatus('GPS權限被拒絕，請在瀏覽器設定中啟用', 'warning');
            }
        });
    }
}

// 頁面載入時檢查GPS權限
document.addEventListener('DOMContentLoaded', function() {
    checkGPSPermission();
});
</script>
{% endblock %}
